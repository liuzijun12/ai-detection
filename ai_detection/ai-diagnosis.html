<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI眼科图像诊断 - 眼部疾病预测中心</title>
    <link rel="stylesheet" href="css/disease-detail.css">
    <link rel="stylesheet" href="css/ai-diagnosis.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .ai-consultation-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(12,26,63,0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(12,26,63, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(41,151,228,0.2);
        }

        .ai-consultation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41,151,228, 0.4);
            background: rgba(12,26,63,1);
            border-color: rgba(41,151,228,0.4);
        }

        .ai-consultation-button i {
            font-size: 24px;
        }

        .ai-chat-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 320px;
            height: 500px;
            background: rgba(12,26,63,0.95);
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(41,151,228,0.2);
        }

        .chat-header {
            background: rgba(12,26,63,1);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(41,151,228,0.2);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: rgba(12,26,63,0.8);
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-message {
            flex-direction: row;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            background: rgba(41,151,228,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4dd0e1;
            border: 1px solid rgba(41,151,228,0.3);
        }

        .message-avatar i {
            font-size: 14px;
        }

        .user-message .message-avatar {
            background: rgba(41,151,228,0.3);
            color: white;
        }

        .message-content {
            background: rgba(41,151,228,0.1);
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #bad0e2;
            border: 1px solid rgba(41,151,228,0.2);
            font-size: 13px;
            line-height: 1.4;
        }

        .user-message .message-content {
            background: rgba(41,151,228,0.2);
            color: white;
        }

        .chat-input-area {
            padding: 15px;
            background: rgba(12,26,63,1);
            border-top: 1px solid rgba(41,151,228,0.2);
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            border: 1px solid rgba(41,151,228,0.3);
            border-radius: 8px;
            padding: 8px 12px;
            resize: none;
            font-size: 13px;
            background: rgba(12,26,63,0.8);
            color: white;
        }

        #chatInput::placeholder {
            color: rgba(186,208,226,0.5);
            font-size: 13px;
        }

        .send-button {
            width: 36px;
            height: 36px;
            background: rgba(41,151,228,0.2);
            color: #4dd0e1;
            border: 1px solid rgba(41,151,228,0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button i {
            font-size: 14px;
        }

        /* 添加滚动条样式 */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(12,26,63,0.8);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(41,151,228,0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(41,151,228,0.5);
        }

        @media screen and (max-width: 768px) {
            .ai-chat-container {
                width: calc(100% - 30px);
                right: 15px;
                left: 15px;
                bottom: 90px;
            }

            .ai-consultation-button {
                right: 15px;
                padding: 12px 16px;
            }
        }

        /* 简化的导航图标样式 */
        .side-icons {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(12,26,63,0.95);
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 100;
        }

        .left-icons {
            left: 0;
            border-radius: 0 12px 12px 0;
        }

        .right-icons {
            right: 0;
            border-radius: 12px 0 0 12px;
        }

        .icon-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4dd0e1;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .icon-item i {
            font-size: 20px;
        }

        .icon-item:hover {
            color: #2997e4;
            transform: translateX(3px);
        }

        .right-icons .icon-item:hover {
            transform: translateX(-3px);
        }

        @media screen and (max-width: 768px) {
            .side-icons {
                display: none;
            }
        }

        /* 双眼上传区域样式 */
        .upload-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .eye-upload-section {
            flex: 1;
            background: rgba(12,26,63,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(41,151,228,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .eye-upload-section h3 {
            color: #2997e4;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .eye-upload-section h3:before {
            content: '\f06e';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
        }

        .upload-area {
            min-height: 200px;
            border: 2px dashed rgba(41,151,228,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(12,26,63,0.05);
            position: relative;
            overflow: hidden;
            aspect-ratio: 16/10;
            max-width: 400px;
            margin: 0 auto;
        }

        .upload-area:hover {
            border-color: #2997e4;
            background: rgba(41,151,228,0.1);
        }

        .upload-area.dragover {
            border-color: #2997e4;
            background: rgba(41,151,228,0.15);
        }

        .upload-placeholder {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .upload-placeholder i {
            font-size: 40px;
            color: #2997e4;
            margin-bottom: 10px;
        }

        .upload-placeholder p {
            margin: 10px 0;
            font-size: 16px;
        }

        .upload-placeholder span {
            font-size: 12px;
            color: #999;
        }

        .image-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(12,26,63,0.95);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .image-preview img {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: block;
            margin: auto;
        }

        /* 诊断结果区域样式 */
        .eye-results {
            display: flex;
            gap: 30px;
            margin: 20px 0;
        }

        .left-eye-results,
        .right-eye-results {
            flex: 1;
            background: rgba(12,26,63,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(41,151,228,0.1);
        }

        .left-eye-results h4,
        .right-eye-results h4 {
            color: #2997e4;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .left-eye-results h4:before,
        .right-eye-results h4:before {
            content: '\f06e';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
        }

        /* 响应式布局 */
        @media screen and (max-width: 768px) {
            .upload-container {
                flex-direction: column;
            }

            .eye-results {
                flex-direction: column;
            }
        }

        /* 添加导出按钮样式 */
        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .retest-button,
        .export-button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .retest-button {
            background: rgba(41,151,228,0.1);
            color: #2997e4;
        }

        .export-button {
            background: #2997e4;
            color: white;
        }

        .retest-button:hover {
            background: rgba(41,151,228,0.2);
        }

        .export-button:hover {
            background: #2080c7;
            transform: translateY(-1px);
        }

        .retest-button i,
        .export-button i {
            font-size: 16px;
        }

        .eye-image img {
            max-width: 150px;
            border: 1px solid #e1e6f0;
            border-radius: 4px;
            padding: 5px;
        }

        .image-section {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }

        .eye-image {
            text-align: center;
            flex: 1;
            max-width: 160px;
            margin: 0 auto;
        }

        .eye-image-caption {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .probability-bar {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        .disease-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .probability-track {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .probability-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .probability-value {
            font-size: 12px;
            margin-top: 4px;
            text-align: right;
            font-weight: bold;
        }
        .success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
    </style>
</head>
<body>
    <!-- 左侧图标 -->
    <div class="side-icons left-icons">
        <div class="icon-item">
            <i class="fas fa-dna"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-eye"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-flask"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-user-md"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-pills"></i>
        </div>
    </div>

    <!-- 右侧图标 -->
    <div class="side-icons right-icons">
        <div class="icon-item">
            <i class="fas fa-cog"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-bell"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-question-circle"></i>
        </div>
        <div class="icon-item">
            <i class="fas fa-comment-dots"></i>
        </div>
    </div>

    <div class="content-body">
        <div class="header">
            <div class="header-left">
                <span>AI眼科图像诊断</span>
            </div>
            <a href="index.html" class="back-button">返回首页</a>
        </div>

        <div class="diagnosis-container">
            <div class="diagnosis-intro">
                <div class="intro-card">
                    <i class="fas fa-microscope"></i>
                    <h3>专业AI分析</h3>
                    <p>基于深度学习模型，对眼部图像进行智能分析</p>
                </div>
                <div class="intro-card">
                    <i class="fas fa-shield-alt"></i>
                    <h3>隐私保护</h3>
                    <p>所有图像数据经加密处理，确保您的隐私安全</p>
                </div>
                <div class="intro-card">
                    <i class="fas fa-clock"></i>
                    <h3>快速诊断</h3>
                    <p>秒级响应，为您提供及时的诊断建议</p>
                </div>
            </div>

            <div class="example-section">
                <h3><i class="fas fa-info-circle"></i> 拍摄示例</h3>
                <div class="example-container">
                    <div class="example-item">
                        <div class="example-image correct">
                            <div class="image-title">正确示例1</div>
                            <img src="image/examples/correct1.png" alt="正确的拍摄示例1">
                            <div class="example-desc">
                                <i class="fas fa-check-circle"></i>
                                <span>光线充足,角度正确</span>
                            </div>
                        </div>
                    </div>
                    <div class="example-item">
                        <div class="example-image correct">
                            <div class="image-title">正确示例2</div>
                            <img src="image/examples/correct2.png" alt="正确的拍摄示例2">
                            <div class="example-desc">
                                <i class="fas fa-check-circle"></i>
                                <span>清晰度高,位置合适</span>
                            </div>
                        </div>
                    </div>
                    <div class="example-item">
                        <div class="example-image wrong">
                            <div class="image-title">错误示例1</div>
                            <img src="image/examples/wrong1.png" alt="错误的拍摄示例1">
                            <div class="example-desc">
                                <i class="fas fa-times-circle"></i>
                                <span>光线不足,模糊</span>
                            </div>
                        </div>
                    </div>
                    <div class="example-item">
                        <div class="example-image wrong">
                            <div class="image-title">错误示例2</div>
                            <img src="image/examples/wrong2.png" alt="错误的拍摄示例2">
                            <div class="example-desc">
                                <i class="fas fa-times-circle"></i>
                                <span>与眼底照片无关</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="upload-section">
                <h2>图像上传</h2>
                <div class="upload-tips">
                    <h4>拍摄建议：</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> 选择光线充足的环境</li>
                        <li><i class="fas fa-check"></i> 保持手机稳定,避免晃动</li>
                        <li><i class="fas fa-check"></i> 确保眼睛区域清晰可见</li>
                        <li><i class="fas fa-check"></i> 避免使用闪光灯</li>
                    </ul>
                </div>
                <div class="upload-container">
                    <div class="eye-upload-section">
                        <h3>左眼</h3>
                        <div class="upload-area" id="leftEyeUploadArea" ondrop="handleDrop(event, 'left')" ondragover="handleDragOver(event)">
                            <input type="file" id="leftEyeInput" accept="image/*" onchange="handleImageUpload(event, 'left')" hidden>
                            <div class="upload-placeholder" id="leftEyePlaceholder">
                                <i class="fas fa-eye"></i>
                                <p>点击或拖拽上传左眼图像</p>
                                <span>支持 jpg、png 格式</span>
                            </div>
                            <div class="image-preview" id="leftEyePreview" style="display: none;">
                                <img id="leftEyePreviewImg" src="" alt="左眼预览图">
                            </div>
                        </div>
                    </div>
                    <div class="eye-upload-section">
                        <h3>右眼</h3>
                        <div class="upload-area" id="rightEyeUploadArea" ondrop="handleDrop(event, 'right')" ondragover="handleDragOver(event)">
                            <input type="file" id="rightEyeInput" accept="image/*" onchange="handleImageUpload(event, 'right')" hidden>
                            <div class="upload-placeholder" id="rightEyePlaceholder">
                                <i class="fas fa-eye"></i>
                                <p>点击或拖拽上传右眼图像</p>
                                <span>支持 jpg、png 格式</span>
                            </div>
                            <div class="image-preview" id="rightEyePreview" style="display: none;">
                                <img id="rightEyePreviewImg" src="" alt="右眼预览图">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-actions" id="previewActions" style="display: none;">
                <button onclick="removeImages()" class="remove-btn">
                    <i class="fas fa-times"></i> 删除
                </button>
                <button onclick="startDiagnosis()" class="analyze-btn" disabled id="analyzeBtn">
                    <i class="fas fa-microscope"></i> 开始分析
                </button>
            </div>

            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h3><i class="fas fa-chart-bar"></i> 诊断结果</h3>
                </div>
                <div class="result-content">
                    <div class="eye-results">
                        <div class="left-eye-results">
                            <h4>左眼诊断结果</h4>
                            <div class="disease-probabilities" id="leftEyeProbabilities">
                                <!-- 左眼预测结果将在这里显示 -->
                            </div>
                        </div>
                        <div class="right-eye-results">
                            <h4>右眼诊断结果</h4>
                            <div class="disease-probabilities" id="rightEyeProbabilities">
                                <!-- 右眼预测结果将在这里显示 -->
                            </div>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button onclick="resetDiagnosis()" class="retest-button">
                            <i class="fas fa-redo"></i> 重新检测
                        </button>
                        <button onclick="exportReport()" class="export-button">
                            <i class="fas fa-file-export"></i> 导出报告
                        </button>
                    </div>
                </div>
            </div>

            <div class="diagnosis-history" id="diagnosisHistory" style="display: none;">
                <h3><i class="fas fa-history"></i> 诊断历史</h3>
                <div class="history-list" id="historyList">
                    <!-- 历史记录将在这里显示 -->
                </div>
            </div>

            <!-- 添加眼部健康知识区域 -->
            <div class="health-knowledge">
                <div class="knowledge-section">
                    <div class="section-header">
                        <i class="fas fa-lightbulb"></i>
                        <span>每日护眼小贴士</span>
                        <span class="update-tag">每日更新</span>
                    </div>
                    <div class="tips-list">
                        <div class="tip-item">
                            <i class="fas fa-clock"></i>
                            <span>建议每隔1小时眺望远处20秒</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-laptop"></i>
                            <span>保持45-50厘米的电脑使用距离</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-carrot"></i>
                            <span>适当补充黄素等营养素</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-eye"></i>
                            <span>定期进行眼部放松按摩</span>
                        </div>
                    </div>
                </div>

                <!-- 添加研究进展区域 -->
                <div class="research-section">
                    <div class="section-header">
                        <i class="fas fa-microscope"></i>
                        <span>最新研究进展</span>
                    </div>
                    <div class="research-list">
                        <div class="research-item">
                            <span class="date">2024-03</span>
                            <span class="title">新型人工智能算法在青光眼早期筛查中的应用研究</span>
                        </div>
                        <div class="research-item">
                            <span class="date">2024-02</span>
                            <span class="title">基于深度学习的视网膜图像分析新方法</span>
                        </div>
                    </div>
                </div>

                <!-- 添加预防保健知识区域 -->
                <div class="prevention-section">
                    <div class="section-header">
                        <i class="fas fa-shield-alt"></i>
                        <span>预防保健知识</span>
                    </div>
                    <div class="prevention-content">
                        <div class="prevention-item">
                            <h4>科学用眼</h4>
                            <p>合理安排工作用眼时间，保持正确姿势和适当照明</p>
                        </div>
                        <div class="prevention-item">
                            <h4>营养搭配</h4>
                            <p>均衡饮食，补充维生素A、C、E等营养素</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI问诊悬浮按钮和对话框 -->
    <div class="ai-consultation-button" id="aiConsultationBtn">
        <i class="fas fa-user-md"></i>
        <span>AI问诊</span>
    </div>

    <div class="ai-chat-container" id="aiChatContainer">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-user-md"></i>
                <span>AI智能问诊</span>
            </div>
            <button class="close-chat" onclick="toggleChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai-message">
                <div class="message-avatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="message-content">
                    您好！我是您的AI医生助手。请描述您的眼部症状，我会为您提供专业的建议。
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <textarea id="chatInput" placeholder="请输入您的症状描述..." rows="2"></textarea>
            <button onclick="sendMessage()" class="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script src="js/ai-diagnosis.js"></script>
    <script>
    const diseaseNames = {
        'G': '青光眼',
        'C': '白内障',
        'A': '年龄相关性黄斑变性',
        'H': '高血压型眼病',
        'D': '糖尿病型眼病',
        'M': '近视',
        'N': '正常'
    };

    const diseaseDescriptions = {
        'G': '青光眼是一种由眼压升高导致视神经损伤的眼病。',
        'C': '白内障是眼睛晶状体混浊，导致视物模糊。',
        'A': '年龄相关性黄斑变性(AMD)会影响中心视力。',
        'H': '高血压导致的视网膜血管改变。',
        'D': '糖尿病引起的视网膜病变。',
        'M': '近视会导致远处物体看不清。',
        'N': '未发现明显的病理性改变。'
    };

    let uploadedImages = {
        left: null,
        right: null
    };

    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.add('dragover');
    }

    function handleDrop(event, eye) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('dragover');
        
        const file = event.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleFile(file, eye);
        }
    }

    function handleImageUpload(event, eye) {
        const file = event.target.files[0];
        if (file) {
            handleFile(file, eye);
        }
    }

    function handleFile(file, eye) {
        // 保存上传的文件
        uploadedImages[eye] = file;

        // 显示预览图
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`${eye}EyePreviewImg`).src = e.target.result;
            document.getElementById(`${eye}EyePlaceholder`).style.display = 'none';
            document.getElementById(`${eye}EyePreview`).style.display = 'block';
        }
        reader.readAsDataURL(file);

        // 显示操作按钮
        document.getElementById('previewActions').style.display = 'flex';
        
        // 检查是否两张图片都已上传
        checkAnalyzeButton();
    }

    function checkAnalyzeButton() {
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = !(uploadedImages.left && uploadedImages.right);
    }

    function removeImages() {
        // 重置左眼
        document.getElementById('leftEyeInput').value = '';
        document.getElementById('leftEyePreviewImg').src = '';
        document.getElementById('leftEyePlaceholder').style.display = 'block';
        document.getElementById('leftEyePreview').style.display = 'none';
        
        // 重置右眼
        document.getElementById('rightEyeInput').value = '';
        document.getElementById('rightEyePreviewImg').src = '';
        document.getElementById('rightEyePlaceholder').style.display = 'block';
        document.getElementById('rightEyePreview').style.display = 'none';

        // 重置上传状态
        uploadedImages = {
            left: null,
            right: null
        };

        // 隐藏操作按钮和结果
        document.getElementById('previewActions').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
        
        // 更新分析按钮状态
        checkAnalyzeButton();
    }

    function startDiagnosis() {
        if (!uploadedImages.left || !uploadedImages.right) {
            showError('请先上传左右眼图片');
            return;
        }

        // 显示加载状态
        showLoading();

        // 创建两个FormData对象
        const leftFormData = new FormData();
        const rightFormData = new FormData();
        leftFormData.append('file', uploadedImages.left);
        rightFormData.append('file', uploadedImages.right);

        // 并行发送两个请求
        Promise.all([
            fetch('http://127.0.0.1:5001/predict', {
                method: 'POST',
                body: leftFormData
            }).then(response => response.json()),
            fetch('http://127.0.0.1:5001/predict', {
                method: 'POST',
                body: rightFormData
            }).then(response => response.json())
        ])
        .then(([leftData, rightData]) => {
            hideLoading();
            displayResults(leftData.predictions, rightData.predictions);

            // 准备要保存的数据
            const detectionData = {
                description: generateDescription(leftData.predictions, rightData.predictions),
                left_eye: {
                    image: document.getElementById('leftEyePreviewImg').src,
                    results: leftData.predictions
                },
                right_eye: {
                    image: document.getElementById('rightEyePreviewImg').src,
                    results: rightData.predictions
                }
            };

            // 调用保存接口
            fetch('http://127.0.0.1:5001/save_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // 包含cookies以获取session
                body: JSON.stringify(detectionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('检测结果已保存');
                } else {
                    showError(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error saving detection:', error);
                showError('保存检测结果时出错');
            });
        })
        .catch(error => {
            hideLoading();
            showError('预测失败，请重试');
            console.error('Error:', error);
        });
    }

    function displayResults(leftPredictions, rightPredictions) {
        const resultSection = document.getElementById('resultSection');
        const leftProbabilitiesContainer = document.getElementById('leftEyeProbabilities');
        const rightProbabilitiesContainer = document.getElementById('rightEyeProbabilities');
        
        leftProbabilitiesContainer.innerHTML = '';
        rightProbabilitiesContainer.innerHTML = '';

        // Sort predictions by probability in descending order
        const sortedLeftPredictions = Object.entries(leftPredictions)
            .sort(([,a], [,b]) => b - a)
            .map(([disease, probability]) => {
                // 将undefined替换为"其他疾病"
                if (disease === 'undefined' || !diseaseNames[disease]) {
                    return ['U', probability];
                }
                return [disease, probability];
            });

        const sortedRightPredictions = Object.entries(rightPredictions)
            .sort(([,a], [,b]) => b - a)
            .map(([disease, probability]) => {
                // 将undefined替换为"其他疾病"
                if (disease === 'undefined' || !diseaseNames[disease]) {
                    return ['U', probability];
                }
                return [disease, probability];
            });

        // 更新疾病名称映射，添加其他疾病
        const displayNames = {
            ...diseaseNames,
            'U': '其他疾病'
        };

        // Display left eye predictions
        sortedLeftPredictions.forEach(([disease, probability]) => {
            const probabilityBar = document.createElement('div');
            probabilityBar.className = 'probability-bar';
            const percentage = (probability * 100).toFixed(2);
            const barColor = getBarColor(probability);
            
            probabilityBar.innerHTML = `
                <div class="disease-name">${displayNames[disease]}</div>
                <div class="probability-track">
                    <div class="probability-fill" style="width: ${percentage}%; background-color: ${barColor}"></div>
                </div>
                <div class="probability-value" style="color: ${barColor}">${percentage}%</div>
            `;
            leftProbabilitiesContainer.appendChild(probabilityBar);
        });

        // Display right eye predictions
        sortedRightPredictions.forEach(([disease, probability]) => {
            const probabilityBar = document.createElement('div');
            probabilityBar.className = 'probability-bar';
            const percentage = (probability * 100).toFixed(2);
            const barColor = getBarColor(probability);
            
            probabilityBar.innerHTML = `
                <div class="disease-name">${displayNames[disease]}</div>
                <div class="probability-track">
                    <div class="probability-fill" style="width: ${percentage}%; background-color: ${barColor}"></div>
                </div>
                <div class="probability-value" style="color: ${barColor}">${percentage}%</div>
            `;
            rightProbabilitiesContainer.appendChild(probabilityBar);
        });

        resultSection.style.display = 'block';
    }

    function getBarColor(probability) {
        if (probability >= 0.5) {
            return '#ff4d4f'; // 高风险 - 红色
        } else if (probability >= 0.3) {
            return '#faad14'; // 中等风险 - 黄色
        } else {
            return '#52c41a'; // 低风险 - 绿色
        }
    }

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.className = 'loading-indicator';
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在分析...';
        document.body.appendChild(loadingDiv);
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
    }

    function resetDiagnosis() {
        removeImages();
        document.querySelector('.upload-section').scrollIntoView({ behavior: 'smooth' });
    }

    // 为左右眼的上传区域添加点击事件
    document.getElementById('leftEyeUploadArea').addEventListener('click', () => {
        document.getElementById('leftEyeInput').click();
    });

    document.getElementById('rightEyeUploadArea').addEventListener('click', () => {
        document.getElementById('rightEyeInput').click();
    });

    // AI问诊相关功能
    const aiConsultationBtn = document.getElementById('aiConsultationBtn');
    const aiChatContainer = document.getElementById('aiChatContainer');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');

    aiConsultationBtn.addEventListener('click', toggleChat);

    function toggleChat() {
        const isVisible = aiChatContainer.style.display === 'flex';
        aiChatContainer.style.display = isVisible ? 'none' : 'flex';
    }

    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // 添加用户消息
        addMessage(message, 'user');
        chatInput.value = '';

        // 显示加载状态
        const loadingMessage = addLoadingMessage();

        // 发送消息到后端
        fetch('http://localhost:5001/chat_ollama', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: message })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '服务器错误');
                });
            }
            return response.json();
        })
        .then(data => {
            // 移除加载消息
            removeLoadingMessage(loadingMessage);
            
            // 添加AI回复，过滤掉思考过程
            if (data.response) {
                // 过滤掉思考过程
                let cleanResponse = data.response;
                
                // 移除可能的思考标记和内容
                cleanResponse = cleanResponse.replace(/<think>[\s\S]*?<\/think>/g, '');
                
                // 移除"您好，我是AI眼科助手。您的问题是："这样的固定开头
                cleanResponse = cleanResponse.replace(/您好，我是AI眼科助手。您的问题是：.*?。/g, '');
                
                // 移除"我正在为您提供专业的眼科咨询服务。"这样的固定结尾
                cleanResponse = cleanResponse.replace(/我正在为您提供专业的眼科咨询服务。/g, '');
                
                // 如果过滤后内容为空，提供默认回复
                if (!cleanResponse.trim()) {
                    cleanResponse = "抱歉，我无法理解您的问题，请尝试重新描述您的症状。";
                }
                
                // 创建一个空的消息容器
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = '<i class="fas fa-user-md"></i>';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = '';
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // 逐字显示回复
                let index = 0;
                const typingInterval = setInterval(() => {
                    if (index < cleanResponse.length) {
                        messageContent.textContent += cleanResponse[index];
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        index++;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 50); // 每50毫秒显示一个字符
            } else {
                addErrorMessage("AI响应格式错误");
            }
        })
        .catch(error => {
            // 移除加载消息
            removeLoadingMessage(loadingMessage);
            // 显示错误消息
            addErrorMessage(error.message || "AI服务暂时不可用，请稍后重试");
            console.error('Error:', error);
        });
    }

    // 添加加载消息
    function addLoadingMessage() {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai-message loading';
        loadingDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="message-content">
                <i class="fas fa-spinner fa-spin"></i> AI正在思考...
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return loadingDiv;
    }

    // 移除加载消息
    function removeLoadingMessage(loadingMessage) {
        if (loadingMessage && loadingMessage.parentNode) {
            loadingMessage.remove();
        }
    }

    // 添加错误消息
    function addErrorMessage(errorText) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message ai-message error';
        errorDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="message-content error-content">
                ${errorText}
            </div>
        `;
        chatMessages.appendChild(errorDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 修改为保留用户消息添加功能，AI消息使用逐字显示
    function addMessage(content, type) {
        if (type === 'user') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="fas fa-user"></i>';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(avatar);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        // AI消息现在在sendMessage函数中使用逐字显示
    }

    // 支持按Enter发送消息
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function exportReport() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN');
        const timeStr = now.toLocaleTimeString('zh-CN');
        const reportId = `AI-${now.getTime()}`;

        const leftEyeResults = getAllPredictions('leftEyeProbabilities');
        const rightEyeResults = getAllPredictions('rightEyeProbabilities');

        const reportContent = `
            <html>
            <head>
                <meta charset="utf-8">
                <style>
                    body { 
                        font-family: "Microsoft YaHei", Arial, sans-serif; 
                        line-height: 1.6; 
                        padding: 40px;
                        color: #333;
                        max-width: 900px;
                        margin: 0 auto;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 40px;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #2997e4;
                    }
                    .section { 
                        margin: 30px 0;
                        background: #fff;
                        padding: 20px;
                        border: 1px solid #e1e6f0;
                        border-radius: 8px;
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin: 15px 0;
                    }
                    th, td { 
                        border: 1px solid #e1e6f0;
                        padding: 12px; 
                        text-align: left;
                    }
                    th { 
                        background: #f8f9fc;
                    }
                    .probability {
                        font-weight: bold;
                    }
                    .high-prob {
                        color: #ff4d4f;
                    }
                    .medium-prob {
                        color: #faad14;
                    }
                    .low-prob {
                        color: #52c41a;
                    }
                    .description {
                        font-size: 14px;
                        color: #666;
                        margin: 10px 0;
                    }
                    .footer {
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px solid #e1e6f0;
                        font-size: 12px;
                        color: #666;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>AI眼科诊断报告</h1>
                    <p>报告编号：${reportId}</p>
                    <p>生成时间：${dateStr} ${timeStr}</p>
                </div>

                <div class="section">
                    <h2>左眼分析结果</h2>
                    <table>
                        <tr>
                            <th>代码</th>
                            <th>疾病名称</th>
                            <th>可能性</th>
                        </tr>
                        ${generateResultsTable(leftEyeResults)}
                    </table>
                    <div class="description">
                        ${generateAnalysisSummary('左', leftEyeResults)}
                    </div>
                </div>

                <div class="section">
                    <h2>右眼分析结果</h2>
                    <table>
                        <tr>
                            <th>代码</th>
                            <th>疾病名称</th>
                            <th>可能性</th>
                        </tr>
                        ${generateResultsTable(rightEyeResults)}
                    </table>
                    <div class="description">
                        ${generateAnalysisSummary('右', rightEyeResults)}
                    </div>
                </div>

                <div class="section">
                    <h2>综合分析</h2>
                    ${generateComprehensiveAnalysis(leftEyeResults, rightEyeResults)}
                </div>

                <div class="footer">
                    <p><strong>注意事项：</strong></p>
                    <p>1. 本报告由AI诊断系统生成，仅供参考。</p>
                    <p>2. 请咨询专业医疗人员进行准确诊断和治疗。</p>
                    <p>3. 概率值表示基于AI模型分析的各项疾病可能性。</p>
                    <p>AI眼科诊断系统生成</p>
                </div>
            </body>
            </html>
        `;

        const blob = new Blob([reportContent], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `AI眼科诊断报告_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function getAllPredictions(containerId) {
        const container = document.getElementById(containerId);
        const predictions = [];
        const probabilityBars = container.getElementsByClassName('probability-bar');
        
        // 创建反向映射表，用于从中文名找到对应的疾病代码
        const reverseMapping = {};
        Object.entries(diseaseNames).forEach(([code, name]) => {
            reverseMapping[name] = code;
        });
        reverseMapping['其他疾病'] = 'U';
        
        Array.from(probabilityBars).forEach(bar => {
            const diseaseName = bar.querySelector('.disease-name').textContent;
            const probability = parseFloat(bar.querySelector('.probability-value').textContent);
            // 根据中文名找到对应的疾病代码
            const diseaseCode = reverseMapping[diseaseName] || 'U';
            predictions.push({
                disease: diseaseCode,
                probability: probability
            });
        });
        
        return predictions;
    }

    function generateResultsTable(results) {
        return results.map(result => {
            const probClass = result.probability >= 50 ? 'high-prob' : 
                             result.probability >= 20 ? 'medium-prob' : 'low-prob';
            // 获取正确的疾病名称显示
            const diseaseName = result.disease === 'U' ? '其他疾病' : diseaseNames[result.disease] || '未知疾病';
            return `
                <tr>
                    <td>${result.disease}</td>
                    <td>${diseaseName}</td>
                    <td class="probability ${probClass}">${result.probability.toFixed(2)}%</td>
                </tr>
            `;
        }).join('');
    }

    function generateAnalysisSummary(eye, results) {
        const sortedResults = [...results].sort((a, b) => b.probability - a.probability);
        const primaryFindings = sortedResults.filter(r => r.probability >= 20);
        
        let summary = `<p><strong>${eye}眼分析总结：</strong></p>`;
        
        if (primaryFindings.length === 0) {
            summary += '<p>未检测到明显的病理性改变。</p>';
        } else {
            summary += '<ul>';
            primaryFindings.forEach(finding => {
                // 获取正确的疾病名称显示
                const diseaseName = finding.disease === 'U' ? '其他疾病' : diseaseNames[finding.disease] || '未知疾病';
                summary += `<li><strong>${diseaseName}：</strong> `;
                summary += `可能性 ${finding.probability.toFixed(2)}%</li>`;
            });
            summary += '</ul>';
        }
        
        return summary;
    }

    function generateComprehensiveAnalysis(leftResults, rightResults) {
        const analysis = [];
        
        const conditions = new Set([...leftResults, ...rightResults].map(r => r.disease));
        
        let content = '<div class="analysis-content">';
        content += '<h3>双眼对比分析：</h3><ul>';
        
        conditions.forEach(condition => {
            const leftProb = leftResults.find(r => r.disease === condition)?.probability || 0;
            const rightProb = rightResults.find(r => r.disease === condition)?.probability || 0;
            
            if (leftProb >= 20 || rightProb >= 20) {
                // 获取正确的疾病名称显示
                const diseaseName = condition === 'U' ? '其他疾病' : diseaseNames[condition] || '未知疾病';
                content += `<li><strong>${diseaseName}：</strong><br>`;
                content += `左眼：${leftProb.toFixed(2)}% | 右眼：${rightProb.toFixed(2)}%<br>`;
                if (Math.abs(leftProb - rightProb) > 10) {
                    content += `<em>注意：双眼检测结果存在显著差异。</em>`;
                }
                content += '</li>';
            }
        });
        
        content += '</ul>';
        
        content += '<h3>主要发现：</h3><ul>';
        const significantFindings = [...leftResults, ...rightResults]
            .filter(r => r.probability >= 30)
            .sort((a, b) => b.probability - a.probability);
        
        if (significantFindings.length > 0) {
            significantFindings.forEach(finding => {
                // 获取正确的疾病名称显示
                const diseaseName = finding.disease === 'U' ? '其他疾病' : diseaseNames[finding.disease] || '未知疾病';
                content += `<li>${diseaseName}（${finding.probability.toFixed(2)}%）- `;
                content += `需要关注</li>`;
            });
        } else {
            content += '<li>未检测到高概率的病理性改变。</li>';
        }
        content += '</ul>';
        
        return content;
    }

    // 添加生成描述的函数
    function generateDescription(leftPredictions, rightPredictions) {
        let description = '检测结果概述：\n';
        
        // 获取最高概率的疾病
        const getTopDisease = (predictions) => {
            return Object.entries(predictions)
                .sort(([,a], [,b]) => b - a)
                .filter(([disease, prob]) => prob > 0.3) // 只考虑概率大于30%的疾病
                .map(([disease, prob]) => ({
                    name: diseaseNames[disease] || '其他疾病',
                    probability: prob
                }));
        };

        const leftTopDiseases = getTopDisease(leftPredictions);
        const rightTopDiseases = getTopDisease(rightPredictions);

        // 添加左眼描述
        description += '\n左眼：';
        if (leftTopDiseases.length > 0) {
            description += leftTopDiseases
                .map(d => `${d.name}(${(d.probability * 100).toFixed(1)}%)`)
                .join('、');
        } else {
            description += '未发现明显异常';
        }

        // 添加右眼描述
        description += '\n右眼：';
        if (rightTopDiseases.length > 0) {
            description += rightTopDiseases
                .map(d => `${d.name}(${(d.probability * 100).toFixed(1)}%)`)
                .join('、');
        } else {
            description += '未发现明显异常';
        }

        // 添加建议
        description += '\n\n建议：';
        if (leftTopDiseases.length > 0 || rightTopDiseases.length > 0) {
            description += '建议及时就医进行详细检查，进行专业医生诊断。';
        } else {
            description += '暂未发现明显异常，建议定期进行眼科检查，保持良好的用眼习惯。';
        }

        return description;
    }

    // 添加成功提示函数
    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
    }
    </script>
</body>
</html> 